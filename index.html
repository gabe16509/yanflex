<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Yanflex - Profissional</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --border-color: #000; --accent-color: #007bff; }
        * { box-sizing: border-box; }
        
        body { font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; background-color: #f4f4f4; margin: 0; }
        .wrapper { width: 790px; background-color: #fff; }

        .header-fixo { display: flex; background-color: #fff; border: 2px solid var(--border-color); width: 100%; margin-bottom: 15px; }
        .empresa-info { flex: 1.5; padding: 8px; text-align: center; border-right: 2px solid var(--border-color); }
        .empresa-info h1 { font-size: 17px; margin: 0; text-transform: uppercase; }
        .empresa-info p { font-size: 13px; margin: 2px 0; font-weight: bold; }
        .contato-info { flex: 1; padding: 8px; font-size: 11px; line-height: 1.3; }

        .tabs-nav { display: flex; gap: 5px; padding-left: 5px; width: 790px; }
        .tab-btn { padding: 8px 20px; cursor: pointer; border: 2px solid var(--border-color); border-bottom: none; background: #d1d1d1; font-weight: bold; text-transform: uppercase; font-size: 11px; border-radius: 6px 6px 0 0; }
        .tab-btn.active { background: #fff; position: relative; z-index: 2; margin-bottom: -2px; }

        .content-container { background-color: #fff; border: 2px solid var(--border-color); width: 100%; min-height: 600px; position: relative; z-index: 1; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        
        .header-meta-notas { border: 1px solid #000; padding: 10px; margin-bottom: 20px; background: #fff; }
        .meta-linha { border-bottom: 1px dotted #000; margin-bottom: 5px; padding-bottom: 2px; }
        .meta-label { font-weight: bold; font-size: 12px; text-transform: uppercase; color: #000; margin-right: 5px; }
        .meta-valor { font-family: 'Courier New', Courier, monospace; font-size: 14px; color: #000; text-transform: uppercase; }
        .meta-resumo-aberto { display: block; font-size: 13px; font-weight: bold; color: #d9534f; margin-top: 5px; }

        .form-papel { display: flex; gap: 20px; align-items: flex-end; }
        .campo-linha { display: flex; border-bottom: 1px solid #000; flex: 1; align-items: flex-end; padding-bottom: 2px; }
        .label { font-weight: bold; font-size: 13px; margin-right: 8px; text-transform: uppercase; }
        .form-papel input { border: none; outline: none; background: transparent; font-family: inherit; font-size: 14px; width: 100%; }

        .lista-dados { margin-top: 30px; border-top: 1px dashed #ccc; padding-top: 10px; }
        .item-lista { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; font-size: 14px; cursor: pointer; transition: background 0.2s; }
        .item-lista:hover { background-color: #f9f9f9; }
        .item-lista.selecionado { background-color: #e7f3ff; border-left: 5px solid var(--accent-color); font-weight: bold; }

        .num-item { color: #888; font-family: monospace; font-weight: bold; margin-right: 10px; border-right: 1px solid #ddd; padding-right: 8px; }
        .link-situacao { color: var(--accent-color); text-decoration: underline; margin-left: 10px; font-weight: normal; cursor: pointer; }
        .paga { color: green; text-decoration: none; font-weight: bold; cursor: default; }

        .controles { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        .btn-acao { padding: 10px 25px; font-weight: bold; cursor: pointer; border: 2px solid #000; background: #fff; text-transform: uppercase; }
        .btn-add { background: #000; color: #fff; padding: 5px 15px; cursor: pointer; border: none; text-transform: uppercase; font-size: 11px; font-weight: bold; }

        @media print { 
            @page { margin: 1cm; }
            body { background-color: #fff; padding: 0; }
            .wrapper { width: 100%; border: none; }
            .tabs-nav, .controles, .btn-add { display: none !important; } 
            .content-container { border: 2px solid #000; }
        }
    </style>
</head>
<body>

    <div class="wrapper">
        <header class="header-fixo">
            <div class="empresa-info">
                <h1>MZ Comércio e Serviços</h1>
                <p>YANFLEX</p>
                <p>Mangueiras e Conexões Hidráulicas</p>
                <p>CNPJ: 18.502.457/0001-60</p>
            </div>
            <div class="contato-info">
                <strong>End:</strong> Rua N, Quadra 121 - Box 14 Área Industrial<br>
                Monte Dourado - PA | CEP: 68.240-00<br>
                <strong>Fone:</strong> (96) 99122-5729
            </div>
        </header>

        <nav class="tabs-nav">
            <button id="btn-tab-clientes" class="tab-btn active" onclick="abrirAba(event, 'clientes')">Clientes</button>
            <button id="btn-tab-notas" class="tab-btn" onclick="abrirAba(event, 'notas')">Notas</button>
            <button id="btn-tab-produtos" class="tab-btn" onclick="abrirAba(event, 'produtos')">Produtos</button>
        </nav>

        <div class="content-container">
            <div id="clientes" class="tab-content active">
                <div class="form-papel">
                    <div class="campo-linha">
                        <span class="label">Nome:</span>
                        <input type="text" id="cli-nome">
                    </div>
                    <div class="campo-linha" style="max-width: 200px;">
                        <span class="label">Telefone:</span>
                        <input type="text" id="cli-fone" placeholder="(00) 00000-0000">
                    </div>
                    <button class="btn-add" onclick="adicionarCliente()">SALVAR</button>
                </div>
                <div class="lista-dados" id="lista-clientes"></div>
            </div>

            <div id="notas" class="tab-content">
                <div class="header-meta-notas">
                    <div class="meta-linha">
                        <span class="meta-label">CLIENTE:</span>
                        <span id="nota-cliente-info" class="meta-valor">NENHUM SELECIONADO</span>
                    </div>
                    <span id="resumo-financeiro" class="meta-resumo-aberto">0 notas em aberto totalizando R$0.00</span>
                </div>

                <div class="form-papel">
                    <div class="campo-linha">
                        <span class="label">Data:</span>
                        <input type="date" id="nota-data">
                    </div>
                    <button class="btn-add" onclick="adicionarNota()">Nova Nota</button>
                </div>
                <div class="lista-dados" id="lista-notas"></div>
            </div>
            
            <div id="produtos" class="tab-content">
                <div class="header-meta-notas">
                    <div class="meta-linha">
                        <span class="meta-label">CLIENTE:</span>
                        <span id="prod-cliente-info" class="meta-valor">NENHUM SELECIONADO</span>
                        <span class="meta-label" style="margin-left: 15px;">| DATA:</span>
                        <span id="prod-data-info" class="meta-valor">--/--/----</span>
                    </div>
                    <span id="resumo-produtos" class="meta-resumo-aberto">0 produtos totalizando R$0.00</span>
                </div>

                <div class="form-papel">
                    <div class="campo-linha">
                        <span class="label">Descrição:</span>
                        <input type="text" id="prod-desc">
                    </div>
                    <div class="campo-linha" style="max-width: 150px;">
                        <span class="label">Preço:</span>
                        <input type="text" id="prod-preco" placeholder="0.00">
                    </div>
                    <button class="btn-add" onclick="adicionarProduto()">Adicionar</button>
                </div>
                <div class="lista-dados" id="lista-produtos"></div>
            </div>
        </div> 
    </div>

    <div class="controles">
        <button class="btn-acao" onclick="location.reload()">Limpar Tudo</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD84TNeKpXJb9sIaJGucg9mTWSuEKudkXY",
            authDomain: "yanflex-aa831.firebaseapp.com",
            databaseURL: "https://yanflex-aa831-default-rtdb.firebaseio.com",
            projectId: "yanflex-aa831",
            storageBucket: "yanflex-aa831.firebasestorage.app",
            messagingSenderId: "681248148266",
            appId: "1:681248148266:web:cdd077e4f6590d20b82c53",
            measurementId: "G-E2SKKRTSWJ"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let clienteSelecionado = null;
        let notaSelecionada = null;

        document.getElementById('nota-data').valueAsDate = new Date();

        function abrirAba(evt, abaNome) {
            // Se for clique manual (evt não é nulo) e estiver tentando sair da aba produtos vazia
            if (evt && evt.type === 'click' && document.getElementById('produtos').classList.contains('active') && abaNome !== 'produtos') {
                const listaProdutos = document.getElementById('lista-produtos');
                if (listaProdutos.children.length === 0) {
                    alert("Adicione pelo menos um produto antes de sair!");
                    return;
                }
            }

            if (abaNome === 'notas' && !clienteSelecionado) {
                alert("Por favor, selecione um cliente primeiro!");
                return;
            }
            if (abaNome === 'produtos' && !notaSelecionada) {
                alert("Por favor, selecione uma nota primeiro!");
                return;
            }

            if (abaNome === 'notas') carregarNotas();
            if (abaNome === 'produtos') carregarProdutos();

            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("tab-btn");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(abaNome).style.display = "block";
            document.getElementById(abaNome).classList.add("active");
            
            const target = (evt && evt.currentTarget) ? evt.currentTarget : document.getElementById('btn-tab-' + abaNome);
            if (target) target.classList.add("active");
        }

        function selecionarCliente(id, nome) {
            clienteSelecionado = { id, nome };
            notaSelecionada = null;
            document.getElementById('nota-cliente-info').innerText = nome;
            document.getElementById('prod-cliente-info').innerText = nome;
            const itens = document.querySelectorAll('#lista-clientes .item-lista');
            itens.forEach(item => item.classList.remove('selecionado'));
            event.currentTarget.classList.add('selecionado');
        }

        function selecionarNota(id, dataNota) {
            notaSelecionada = { id, dataNota };
            document.getElementById('prod-data-info').innerText = dataNota;
            const itens = document.querySelectorAll('#lista-notas .item-lista');
            itens.forEach(item => item.classList.remove('selecionado'));
            
            // Tenta encontrar o item na lista para marcar como selecionado visualmente
            const todosItens = document.querySelectorAll('#lista-notas .item-lista');
            todosItens.forEach(item => {
                // Aqui uma lógica simples de comparação (pode ser melhorada)
                if(item.innerText.includes(dataNota)) item.classList.add('selecionado');
            });
        }

        function adicionarNota() {
            const dataNota = document.getElementById('nota-data').value;
            if (!dataNota) return alert("Preencha a Data da nota!");

            const novaNotaRef = database.ref('notas/' + clienteSelecionado.id).push();
            
            novaNotaRef.set({
                dataNota, 
                total: "0.00",
                situacao: "em aberto"
            }).then(() => {
                document.getElementById('nota-data').valueAsDate = new Date();
                // Define a nota selecionada antes de mudar de aba
                notaSelecionada = { id: novaNotaRef.key, dataNota: dataNota };
                document.getElementById('prod-data-info').innerText = dataNota;
                
                // Abre a aba sem passar o evento (null) para pular a trava de segurança
                abrirAba(null, 'produtos');
            });
        }

        function alterarStatusNota(notaId, statusAtual) {
            if (statusAtual === "paga") return;
            if (confirm("Confirmar que esta nota foi paga?")) {
                database.ref('notas/' + clienteSelecionado.id + '/' + notaId).update({
                    situacao: "paga"
                });
            }
        }

        function carregarNotas() {
            database.ref('notas/' + clienteSelecionado.id).on('value', (snapshot) => {
                const lista = document.getElementById('lista-notas');
                lista.innerHTML = "";
                let notasArray = [];
                let qtdAberto = 0;
                let somaAberto = 0;

                snapshot.forEach((child) => {
                    const dados = child.val();
                    notasArray.push({ id: child.key, ...dados });
                    if (dados.situacao === "em aberto" || !dados.situacao) {
                        qtdAberto++;
                        somaAberto += parseFloat(dados.total || 0);
                    }
                });

                const termoNota = qtdAberto === 1 ? "nota" : "notas";
                document.getElementById('resumo-financeiro').innerText = `${qtdAberto} ${termoNota} em aberto totalizando R$${somaAberto.toFixed(2)}`;

                const totalNotas = notasArray.length;
                notasArray.reverse().forEach((nota, index) => {
                    const item = document.createElement('div');
                    item.className = 'item-lista';
                    if(notaSelecionada && notaSelecionada.id === nota.id) item.classList.add('selecionado');
                    
                    item.onclick = (e) => selecionarNota(nota.id, nota.dataNota);
                    item.ondblclick = (e) => {
                        selecionarNota(nota.id, nota.dataNota);
                        abrirAba({currentTarget: document.getElementById('btn-tab-produtos')}, 'produtos');
                    };

                    const numeroExibido = totalNotas - index;
                    const classeStatus = nota.situacao === 'paga' ? 'link-situacao paga' : 'link-situacao';

                    item.innerHTML = `
                        <div>
                            <span class="num-item">${String(numeroExibido).padStart(2, '0')}</span>
                            <span>${nota.dataNota}</span>
                            <span class="${classeStatus}" onclick="event.stopPropagation(); alterarStatusNota('${nota.id}', '${nota.situacao}')">
                                (${nota.situacao || 'em aberto'})
                            </span>
                        </div>
                        <strong>R$ ${nota.total}</strong>
                    `;
                    lista.appendChild(item);
                });
            });
        }

        function adicionarCliente() {
            const nome = document.getElementById('cli-nome').value;
            const fone = document.getElementById('cli-fone').value;
            if (!nome || !fone) return alert("Preencha Nome e Telefone!");
            database.ref('clientes').push({ nome, fone }).then(() => {
                document.getElementById('cli-nome').value = "";
                document.getElementById('cli-fone').value = "";
            });
        }

        database.ref('clientes').on('value', (snapshot) => {
            const lista = document.getElementById('lista-clientes');
            lista.innerHTML = "";
            snapshot.forEach((child) => {
                const cli = child.val();
                const item = document.createElement('div');
                item.className = 'item-lista';
                if(clienteSelecionado && clienteSelecionado.id === child.key) item.classList.add('selecionado');
                item.onclick = (e) => selecionarCliente(child.key, cli.nome);
                item.ondblclick = (e) => {
                    selecionarCliente(child.key, cli.nome);
                    abrirAba({currentTarget: document.getElementById('btn-tab-notas')}, 'notas');
                };
                item.innerHTML = `<span>${cli.nome}</span> <strong>${cli.fone}</strong>`;
                lista.appendChild(item);
            });
        });

        function adicionarProduto() {
            const desc = document.getElementById('prod-desc').value;
            const precoStr = document.getElementById('prod-preco').value.replace(',', '.');
            const preco = parseFloat(precoStr);

            if (!desc || isNaN(preco)) return alert("Preencha Descrição e Preço corretamente!");
            
            database.ref('produtos/' + notaSelecionada.id).push({ 
                descricao: desc, 
                preco: preco.toFixed(2) 
            }).then(() => {
                document.getElementById('prod-desc').value = "";
                document.getElementById('prod-preco').value = "";
                
                database.ref('produtos/' + notaSelecionada.id).once('value', (snapshot) => {
                    let soma = 0;
                    snapshot.forEach(child => {
                        soma += parseFloat(child.val().preco);
                    });
                    database.ref('notas/' + clienteSelecionado.id + '/' + notaSelecionada.id).update({
                        total: soma.toFixed(2)
                    });
                });
            });
        }

        function carregarProdutos() {
            database.ref('produtos/' + notaSelecionada.id).on('value', (snapshot) => {
                const lista = document.getElementById('lista-produtos');
                lista.innerHTML = "";
                let soma = 0;
                let contador = 0;

                snapshot.forEach((child) => {
                    const prod = child.val();
                    soma += parseFloat(prod.preco);
                    contador++;

                    const item = document.createElement('div');
                    item.className = 'item-lista';
                    item.style.cursor = "default";
                    item.innerHTML = `<span>${prod.descricao}</span> <strong>R$ ${prod.preco}</strong>`;
                    lista.appendChild(item);
                });

                const termoProd = contador === 1 ? "produto" : "produtos";
                document.getElementById('resumo-produtos').innerText = `${contador} ${termoProd} totalizando R$${soma.toFixed(2)}`;
            });
        }
    </script>
</body>
</html>
